
include:
  - gate.docker-compose.yaml
  - http.docker-compose.yaml
  - ui.docker-compose.yaml
services:
  atlas:
      image: $APPLICATION_HALL_IMAGE
      depends_on:
        atlas-caddy-entri:
          condition: service_completed_successfully          
        atlas-caddy-gate:
          condition: service_completed_successfully          
      entrypoint: launcher
      command: /bin/bash -c "echo 'Done with atlasfiles'"
  atlas-caddy-global:
      image: $APPLICATION_HALL_IMAGE
      entrypoint: launcher
      command: |
        /bin/bash -c "echo 'Clearing Caddyfile' && 
        true > /caddy/Caddyfile &&
        echo '{' >> /caddy/Caddyfile &&
        echo '    local_certs' >> /caddy/Caddyfile &&
        echo '}' >> /caddy/Caddyfile &&
        echo '' >> /caddy/Caddyfile &&
        echo '### Generated by $COMPOSE_PROJECT_NAME. Do not modify.' >> /caddy/Caddyfile"
      environment:
        COMPOSE_PROJECT_NAME: $COMPOSE_PROJECT_NAME
      volumes: &caddyfile_volumes
          - ${HOME}/.cache/levicape/${COMPOSE_PROJECT_NAME}/atlas/caddy:/caddy      
  atlas-caddy-entri:
      image: $APPLICATION_HALL_IMAGE
      entrypoint: launcher
      depends_on:
        atlas-caddy-global:
          condition: service_completed_successfully      
      command: |
        /bin/bash -c "echo 'Appending to Caddyfile' 
        && echo 'entri.platform {
        ' >> /caddy/Caddyfile 
        && pnpm exec nx run-many -t atlas && echo '}
        ' >> /caddy/Caddyfile"
      environment:
        COMPOSE_PROJECT_NAME: $COMPOSE_PROJECT_NAME
        ATLAS_CADDYFILE: /caddy/Caddyfile
        ENTRI_HTTP_HOST: http:${ENTRI_HTTP}
        ENTRI_UI_HOST: ui:${ENTRI_UI}      
      volumes: *caddyfile_volumes
  atlas-caddy-gate:
      image: $APPLICATION_HALL_IMAGE
      depends_on:
        atlas-caddy-entri:
          condition: service_completed_successfully      
      entrypoint: launcher
      command: |
        /bin/bash -c "echo 'Appending to Caddyfile' 
        && echo 'gate.platform {
        ' >> /caddy/Caddyfile 
        && pnpm exec nx run-many -t atlas && echo '}
        ' >> /caddy/Caddyfile"
      environment:
        COMPOSE_PROJECT_NAME: $COMPOSE_PROJECT_NAME
        ATLAS_CADDYFILE: /caddy/Caddyfile
        GATE_HTTP_HOST: gate-http:${GATE_HTTP}
        GATE_UI_HOST: gate-ui:${GATE_UI}
      volumes: *caddyfile_volumes



